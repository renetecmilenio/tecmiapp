<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro - Sesi√≥n 4</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    /* Evitar parpadeo inicial */
    .registro-container {
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .registro-container.show {
      opacity: 1;
    }

    .registro-container {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 450px;
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo h1 {
      color: #333;
      margin: 0;
      font-size: 2.5em;
    }

    .logo p {
      color: #666;
      margin: 5px 0 0 0;
      font-size: 0.9em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .mensaje {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .mensaje.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .mensaje.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .mensaje.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .links {
      text-align: center;
      margin-top: 20px;
    }

    .links a {
      color: #667eea;
      text-decoration: none;
      margin: 0 10px;
    }

    .links a:hover {
      text-decoration: underline;
    }

    .divider {
      margin: 20px 0;
      text-align: center;
      color: #666;
    }

    .info-box {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #495057;
    }

    .info-box h4 {
      margin: 0 0 10px 0;
      color: #333;
    }

    .info-box ul {
      margin: 0;
      padding-left: 20px;
    }
  </style>
</head>

<body>
  <div class="registro-container">
    <div class="logo">
      <h1>üìù</h1>
      <p>Crear nueva cuenta</p>
    </div>

    <div class="info-box">
      <h4>‚ÑπÔ∏è Informaci√≥n importante:</h4>
      <ul>
        <li>Las cuentas nuevas se crean como <strong>cliente</strong></li>
        <li>Solo el superadmin puede crear admins</li>
        <li>La contrase√±a debe tener m√≠nimo 6 caracteres</li>
      </ul>
    </div>

    <div id="mensaje" class="mensaje"></div>

    <form id="registroForm">
      <div class="form-group">
        <label for="nombre">Nombre completo:</label>
        <input type="text" id="nombre" name="nombre" required>
      </div>

      <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>
      </div>

      <div class="form-group">
        <label for="password">Contrase√±a:</label>
        <input type="password" id="password" name="password" required minlength="6">
      </div>

      <div class="form-group">
        <label for="confirmPassword">Confirmar contrase√±a:</label>
        <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6">
      </div>

      <button type="submit" class="btn" id="registroBtn">Crear Cuenta</button>
    </form>

    <div class="divider">‚Äî o ‚Äî</div>

    <div class="links">
      <a href="/login">¬øYa tienes cuenta? Inicia sesi√≥n</a><br><br>
      <a href="/">‚Üê Volver al inicio</a>
    </div>
  </div>

  <script>
    const form = document.getElementById('registroForm')
    const mensaje = document.getElementById('mensaje')
    const registroBtn = document.getElementById('registroBtn')

    // Funci√≥n para mostrar mensajes
    function mostrarMensaje (texto, tipo = 'error') {
      mensaje.innerHTML = texto
      mensaje.className = `mensaje ${tipo}`
      mensaje.style.display = 'block'

      if (tipo !== 'success') {
        setTimeout(() => {
          mensaje.style.display = 'none'
        }, 5000)
      }
    }

    // Manejar env√≠o del formulario
    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      const nombre = document.getElementById('nombre').value.trim()
      const email = document.getElementById('email').value.trim()
      const password = document.getElementById('password').value
      const confirmPassword = document.getElementById('confirmPassword').value

      // Validaciones b√°sicas
      if (!nombre || !email || !password || !confirmPassword) {
        mostrarMensaje('Por favor completa todos los campos')
        return
      }

      if (nombre.length < 2) {
        mostrarMensaje('El nombre debe tener al menos 2 caracteres')
        return
      }

      if (password.length < 6) {
        mostrarMensaje('La contrase√±a debe tener al menos 6 caracteres')
        return
      }

      if (password !== confirmPassword) {
        mostrarMensaje('Las contrase√±as no coinciden')
        return
      }

      // Deshabilitar bot√≥n durante el request
      registroBtn.disabled = true
      registroBtn.textContent = 'Creando cuenta...'



      try {
        const response = await fetch('/api/auth/registro', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ nombre, email, password })
        })

        let data
        try {
          data = await response.json()
        } catch (jsonError) {
          // Si la respuesta no es JSON (como rate limiter), usar el texto
          const textResponse = await response.text()
          data = { message: textResponse }
        }

        if (response.ok) {
          // Registro exitoso
          mostrarMensaje(
            `üéâ ¬°Cuenta creada exitosamente!<br>
                        <strong>Nombre:</strong> ${data.usuario.nombre}<br>
                        <strong>Email:</strong> ${data.usuario.email}<br>
                        <strong>Rol:</strong> ${data.usuario.rol}<br><br>
                        Ser√°s redirigido al dashboard en 3 segundos...`,
            'success'
          )

          // Guardar token en localStorage
          localStorage.setItem('token', data.token)
          localStorage.setItem('usuario', JSON.stringify(data.usuario))

          // Limpiar formulario
          form.reset()

          // Redirigir al dashboard despu√©s de 3 segundos
          setTimeout(() => {
            window.location.href = '/dashboard'
          }, 3000)
        } else {
          // Error en registro
          let errorMessage = 'Error al crear la cuenta'

          if (data.message) {
            errorMessage = data.message

            // Si hay errores espec√≠ficos de validaci√≥n, mostrarlos
            if (data.errors && data.errors.length > 0) {
              const errorList = data.errors.map(error => `‚Ä¢ ${error.msg}`).join('<br>')
              errorMessage = `${data.message}:<br><br>${errorList}`
            }
          } else if (data.mensaje) {
            errorMessage = data.mensaje
          }

          mostrarMensaje(errorMessage)
        }
      } catch (error) {
        console.error('Error:', error)
        mostrarMensaje('Error de conexi√≥n. Int√©ntalo de nuevo.')
      } finally {
        // Rehabilitar bot√≥n
        registroBtn.disabled = false
        registroBtn.textContent = 'Crear Cuenta'
      }
    })

    // Verificar si ya est√° logueado
    window.onload = () => {
      const token = localStorage.getItem('token')
      const usuario = localStorage.getItem('usuario')

      console.log('Registro - Token en localStorage:', token ? 'Existe' : 'No existe')
      console.log('Registro - Usuario en localStorage:', usuario ? 'Existe' : 'No existe')

      if (token && usuario) {
        try {
          // Verificar que el usuario sea v√°lido
          const userData = JSON.parse(usuario)
          if (userData && userData.id) {
            console.log('Registro - Redirigiendo a dashboard...')
            window.location.href = '/dashboard'
            return
          }
        } catch (error) {
          console.log('Registro - Error parsing usuario, limpiando localStorage')
          localStorage.clear()
        }
      }

      // Si llegamos aqu√≠, mostrar formulario de registro
      console.log('Registro - Mostrando formulario de registro')
      document.querySelector('.registro-container').classList.add('show')
    }
  </script>
</body>

</html>